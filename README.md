# lms-приложение: платформа для онлайн обучения

SPA веб-приложение, где бэкенд-сервер возвращает клиенту JSON-структуры. 
LMS-система, в которой каждый желающий может размещать свои полезные материалы или курсы.

# Инструкция по установке и использованию разработанного функционала приложения
1. Клонируйте репозиторий:
```
git clone https://github.com/4usnok/DZ5_DRF_materials_apps.git
```
2. Установите зависимости:
```
poetry install
```
3. Активировать окружение
```
poetry env activate
```
# Содержание проекта
## Приложение `course`
Приложение предназначенное для работы с курсом и уроками
1. Содержит `models.py`:
* Модель курса `Course`
* Модель урока `Lesson`
* Модель подписки `Subscription`

2. Содержит `serializers.py`:
* Сериализатор для модели `Lesson` -> `LessonSerializers`
* Сериализатор для модели `Course` -> `CourseSerializers`
* Сериализатор для модели `Course` -> `CourseSerializers`
3. Содержит `views.py`:
* `CourseViewSet` -> ViewSet CRUD для модели `Course`
* `LessonAPIView` -> Просмотр списка уроков
* `LessonAPICreate` -> Создание урока
* `LessonAPIUpdate` -> Редактирование урока
* `LessonList` -> Просмотр отдельного урока
* `LessonAPIDestroy` -> Удаление урока
* `SubscriptionActivate` -> Активация подписки
4. Содержит `permissions.py` -> классы прав доступа для групп админки
5. Содержит `paginators.py` -> для создания пагинации просмотра объектов
6. Содержит `tests.py` -> для тестов
7. Содержит `validators.py` -> для создания валидации
8. Содержит `tasks.py` -> для периодических задач:
* `send_info_about_update_course` -> функция для отправки сообщения на электронную почту
* `check_login_user` -> функция изменения статуса на неактивный, в случае, если пользователь не был онлайн не меньше месяца


## Приложение `users`
Приложение предназначенное для работы с пользователями и платежами
1. Содержит `models.py`:
* Модель пользователя `User`
* Модель платежа `Payments`
2. Содержит `serializers.py`:
* Сериализатор для модели `User` -> `UserSerializers`
* Сериализатор для модели `Payments` -> `PaymentsSerializers`
3. Содержит `views.py`:
* `UserViewSet` -> ViewSet CRUD для модели `User`
* `PaymentsListAPIView` -> Фильтрация и сортировка платежей
* `PaymentsAPICreate` -> Создание платежа
* `PaymentsAPIUpdate` -> Редактирование платежа
* `PaymentsDetailList` -> Просмотр отдельного платежа
* `PaymentsAPIDestroy` -> PaymentsAPIDestroy
4. Содержит `services.py` -> для сервисных функций:
* Содержит сервисную функцию `create_product` -> для создания продукта
* Содержит сервисную функцию `create_price` -> для создания цены
* Содержит сервисную функцию `create_session_to_url` -> для создания сессии для получения ссылки на оплату
5. Содержит `permission.py` -> для прав доступа:
* Содержит `has_permission` -> для разрешения доступа только модераторам
* Содержит `IsOwner` -> для разрешения доступа только владельцам

## Прочие файлы
1. `.env.sample` -> Заполняется в первую очередь(предназначен для заполнений host, port, пароля от бд, названия бд и тд.)
2. `payments_fixture.json` -> содержит json-файлы модели `Payments`
3. `users_fixture.json` -> содержит json-файлы модели `User`
4. `Readme.md` -> содержит описание проекта
5. `docker-compose.yaml` -> Один конфигурационный файл, который объединяет весь функционал в 
многоконтейнерном Docker-приложении
6. `Dockerfile.txt` -> файл с инструкциями для автоматического создания Docker-образов, 
включающий установку зависимостей и настройку окружения.
7. `pyproject.toml` -> список зависимостей и настроек проекта в poetry
8. `.github` -> в директории `workflows` лежит файл `ci.yml` -> он предназначен для настройки деплоя по методу CI на github
9. `nginx` содержит два файла: 
* `Dockerfile` -> предназначен для настроек nginx
* `nginx.conf` -> в файле находятся глобальные директивы, которые определяют общие настройки для всего сервера.

# Полезные команды
* Запуск виртуального окружения poetry: `poetry env activate`
* Запуск сервера: `python manage.py runserver`,
* Создание суперюзера(админка): `python manage.py createsuperuser`,
* Создание миграций: `python manage.py makemigrations`,
* Сохранение миграций: `python manage.py migrate`,
* Откат всех миграций: `python manage.py migrate name_migration`, где `name_migration` -> название миграции.
* Создание фикстуры для модели пользователей `User`: `python -Xutf8 manage.py dumpdata users.User --output users_fixture.json --indent 4`
* Создание фикстуры для модели платежей `Payments`: `python -Xutf8 manage.py dumpdata users.Payments --output payments_fixture.json --indent 4`
* Создания файла с покрытием `.coverage`: `coverage run --source='.' manage.py test`
* Посмотреть покрытие unit-тестами: `coverage report`
* Запуск обработчика очереди (worker) для получения задач и их выполнения: `celery -A config worker -l INFO`
* Запуск redis-server: `./redis-server.exe`
* Запуск redis-cli: `./redis-cli.exe`
* Собирает образы для всех сервисов в фоновом режиме, используя Dockerfile, определенный в конфигурации: `docker-compose up -d --build`
* Вывод логов контейнеризации: `docker-compose logs db`
* Запускает все сервисы, определенные в файле: `docker-compose up`

## Работа с программой
1. Чтобы подключить возможность отправки сообщений на почту при обновлении курса, необходимо сделать следующее:
* Запустить redis-сервер: `./redis-server.exe`
* Запустить worker: `celery -A config worker -l INFO`
* Запустить beat: `celery -A config beat -l INFO`
2. Запуск сервера осуществляется командой: `python manage.py runserver`

## Инструкции по настройке удаленного сервера и деплоя

# Создание и настройка виртуальной машины и сервера

Шаг 1. Создание виртуальной машины и обновление системы:
1. Создание ВМ происходит на Yandex Cloud:
`console.yandex.cloud/`

2. Перед подключением к ВМ, необходимо убедиться, что все пакеты имеют актуальные версии, а система имеет рабочее состояние
Шаг 1. Команда для обновления списка пакетов -> `sudo apt update`
Шаг 2. Команда для обновления всех установленных пакетов до их последних версий -> `sudo apt upgrade`

3. В терминале `Bash` или `Powershell` необходимо ввести команду, чтобы подключить к ВМ. Обычно, команда в характеристиках ВМ
на сервисе Yandex Cloud. Примерная структура будет `ssh username@1.234.567.89`, где: 
username -> это имя пользователя ВМ
1.234.567.89 -> публичный id

Шаг 2. Установка Докера состоит из последовательности команд, которые можно найти по ссылке в документации:
https://docs.docker.com/engine/install/ubuntu/

Шаг 3. Настройка файрвола
Шаг 1. Сначала проверьте состояние файрвола с помощью команды:
`sudo ufw status`
Если файрвол отключен, активируйте его:
`sudo ufw enable`

Шаг 2. Теперь откройте необходимые порты:
Порт 80 для HTTP:
`sudo ufw allow 80/tcp`
Порт 443 для HTTPS:
`sudo ufw allow 443/tcp`

Шаг 3. После открытия портов проверьте настройки файрвола, чтобы убедиться, что правила применились:
`sudo ufw status`

В результате выполнения этой команды вы должны увидеть, что порты 80 и 443 находятся в состоянии 
ALLOW, что означает разрешение входящих соединений через эти порты.

Шаг 4. Порт 22.
Чтобы обеспечить доступ к вашему серверу по SSH, необходимо оставить открытым порт 22. 
Для этого выполните следующие шаги:

Шаг 1. Откройте порт 22 для SSH.
Введите следующую команду в терминале, чтобы разрешить входящие соединения через порт 22:
`sudo ufw allow 22/tcp`

Шаг 2. Проверьте настройки файрвола.
После добавления порта, проверьте состояние файрвола снова, чтобы убедиться, что порт 22 также открыт:
`sudo ufw status`

Ожидаемый результат:
В результате выполнения команды вы должны увидеть, что порт 22 находится в состоянии ALLOW наряду с портами 80 и 443. 
Это означает, что ваш сервер будет доступен для SSH-подключений, а также для веб-трафика.

Теперь ваш сервер безопасен и доступен для управления через SSH, а также для обработки HTTP и HTTPS запросов.

# Ручной деплой приложения

Ручной деплой состоит из нескольких шагов:
Шаг 1. Подключение к ВМ 
В `Bash` или `Powershell` необходимо ввести команду:
`ssh username@1.234.567.89`, где
username -> это никнейм ВМ
1.234.567.89 -> это публичный IPv4

Шаг 2. Клонирование репозитория:
команда -> `git clone ssh-код репозитория`

Шаг 3. Права доступа
Настройка прав пользователя иногда может потребоваться и она состоит из следующих шагов:
Шаг 1. Добавьте пользователя в группу docker:
`sudo usermod -aG docker $USER`
Шаг 2. Применить изменения групп (выйдите и войдите заново, или выполните):
`newgrp docker`
Шаг 3. Проверить, что пользователь добавлен в группу docker:
`groups`
Шаг 4. Проверить работу Docker:
`docker ps`

Шаг 4. Подгрузка недостающих файлов:
Баш может не найти нужные для деплоя файлы. В этом случае, необходимо будет обратиться на удалённый репозиторий, 
вместе с этим, баш подгрузит все недостающие файлы:
Команда -> `git ls-tree -r origin/homework_35_2 —name-only`, где нужно поменять homework_35_2 на свою ветку
`origin` -> это для удалённых веток, поэтому необходимо оставить

Шаг 5. Запуск docker-compose или по другому -> деплой:
`docker-compose up -d`

# Деплой по методу CI
Деплой по методу CI осуществляется на гитхабе во вкладке Actions, настройки сервера и 
контейнера находятся в директории: `/.github/workflows` в файле `ci.yml`
